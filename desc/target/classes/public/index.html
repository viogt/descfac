<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<link rel="stylesheet" href="public/styles.css">
    <script src="public/script.js"></script>-->
    <title>▲ Upload and Analyze</title>
    <style>
        body {
            background-color: #222;
            padding: 20px;
            color: #ccc;
            margin: 0;
        }

        .container {
            max-width: 440px;
            margin: auto;
            padding: 24px;
            background-color: #444;
            box-shadow: 0 4px 8px #000;
            border-radius: 16px;
            font: normal 15px Arial, sans-serif;
        }

        h2 {
            font: bold 24px Arial, sans-serif;
            color: #ccc;
        }

        input[type="file"] {
            font-size: 16px;
        }

        ::file-selector-button {
            border: none;
            padding: 5px 10px;
            border-radius: 10px;
            background: linear-gradient(to bottom, #464, #242);
            color: #ccc;
        }

        #progress {
            width: 100%;
            height: 32px;
            background-color: #333;
            margin: 20px 0;
            border-radius: 16px;
            overflow: hidden;
        }

        #bar {
            height: 100%;
            width: 0;
            background: linear-gradient(to bottom, #464, #242);
            transition: .2s;
            color: #fff;
            text-align: center;
            font: normal 16px/32px Arial, sans-serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-top: .6px solid #333;
        }

        td {
            padding: 6px;
            text-align: left;
            border-bottom: .6px solid #333;
        }

        b {
            font-weight: normal;
            padding: 2px 6px;
            background-color: #820;
            border-radius: 6px;
        }

        b[lilac] {
            background-color: #530;
        }

        .fadeIn {
            animation: fadeIn 0.8s ease forwards;
        }

        @keyframes fadeIn {
            from {
                transform: scale(.3);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>▲ Upload .xlsx file</h2>
        <input type="file" id="fileInput" accept=".xlsx" onchange="uploadFile()">
        <div id="progress">
            <div id="bar"></div>
        </div>
        <div id="message"></div>
        <div id="rezultat"></div>
    </div>
    <script>
        const log = document.getElementById("message");
        const bar = document.getElementById("bar");
        const rezultat = document.getElementById("rezultat");

        const es = new EventSource("/events");
        let progress;

        function out(s) {
            const el = document.createElement("p");
            el.innerHTML = s;
            log.appendChild(el);
            el.classList.add("fadeIn");
            window.scroll({ top: document.body.scrollHeight, behavior: 'smooth' });
        }
        es.onmessage = (event) => {
            let percent;
            //log.innerHTML += event.data.substr(event.data.indexOf(' ')+1) + "<br>";
            if (event.data.charAt(0) == '0') return;
            if (event.data.charAt(0) == '+') percent = '100%';
            else {
                const n = parseInt(event.data);
                if (Number.isNaN(n)) return;
                percent = (progress += n) + '%';
            }
            out(event.data.substr(event.data.indexOf(' ') + 1));
            bar.style.width = percent;
            bar.textContent = percent;
        };

        es.onerror = () => {
            //log.innerHTML += "<br><font color='red'>[Error / connection lost]</font>";
            out("<br><font color='red'>[Error / connection lost]</font>");
        };

        async function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0]; // Get the first selected file
            const messageElement = log;

            /*if (!file || !file.name.endsWith(".xlsx")) {
              messageElement.innerHTML = "<font color='red'>Please select an .XLSX file.</font>";
              return;
            }*/
            messageElement.innerHTML = "";
            rezultat.innerHTML = "";
            progress = 0;

            const formData = new FormData();
            formData.append("myFile", file);

            try {
                const response = await fetch("/upload", {
                    method: "POST",
                    body: formData,
                });

                if (response.ok) {
                    rezultat.innerHTML = await response.text();
                    window.scroll({ top: document.body.scrollHeight, behavior: 'smooth' });
                }
                else {
                    const errorText = await response.text();
                    rezultat.textContent = "Upload failed:" + response.status + " - " + errorText;
                }
            } catch (error) {
                rezultat.innerHTML = "<font color='red'>Network error:</font> " + error.message;
                console.error("Fetch error:", error);
            }
        }
    </script>
</body>

</html>